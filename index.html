<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MasterApp - Gestor de Tarefas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .bg-master { background-color: #BB00FF; }
        .text-master { color: #BB00FF; }
        .border-master { border-color: #BB00FF; }
        .ring-master:focus { --tw-ring-color: #BB00FF; }
        .hover-master:hover { opacity: 0.9; }

        .kanban-container {
            display: flex;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            gap: 1.5rem;
            padding-bottom: 1.5rem;
            -webkit-overflow-scrolling: touch;
        }
        .kanban-column {
            flex: 0 0 320px;
            scroll-snap-align: center;
            min-height: 70vh;
        }
        @media (min-width: 768px) { .kanban-column { flex: 0 0 380px; scroll-snap-align: start; } }

        .task-card { transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .task-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(187, 0, 255, 0.15); }

        .custom-scrollbar::-webkit-scrollbar { height: 8px; width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        .modal-active { display: flex !important; animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .color-dot { width: 24px; height: 24px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; }
        .color-dot.active { border-color: #1e293b; transform: scale(1.2); }
        .category-dropdown { max-height: 150px; overflow-y: auto; z-index: 110; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 custom-scrollbar">

    <div id="app">
        <div class="min-h-screen flex items-center justify-center">
            <div class="text-center">
                <div class="w-16 h-16 text-master mx-auto mb-4 animate-bounce">
                    <svg viewBox="0 0 100 100" class="fill-none stroke-current"><path d="M20 70V30L50 55L80 30V70" stroke-width="8" stroke-linecap="round" stroke-linejoin="round"/></svg>
                </div>
                <p class="text-slate-400 font-medium animate-pulse">A carregar MasterApp...</p>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="confirm-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[200] hidden items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-sm p-8 text-center">
            <h3 class="text-xl font-bold mb-2 text-slate-800" id="confirm-title">Confirmar?</h3>
            <p class="text-slate-500 mb-6" id="confirm-text"></p>
            <div class="flex gap-3">
                <button onclick="closeConfirmModal()" class="flex-1 px-4 py-3 bg-slate-100 rounded-xl font-bold">Cancelar</button>
                <button id="confirm-action-btn" class="flex-1 px-4 py-3 bg-red-600 text-white font-bold rounded-xl shadow-lg shadow-red-100">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Notifications -->
    <div id="toast" class="fixed top-20 left-1/2 -translate-x-1/2 z-[300] hidden">
        <div class="bg-slate-800 text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-3">
            <i class="fas fa-info-circle text-purple-400"></i>
            <span id="toast-message"></span>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, addDoc, updateDoc, deleteDoc, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // MANTENDO SUAS CHAVES DO FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyBhcrxANmCC8-3vns_db3qlKmhRZYh3yxQ",
            authDomain: "masterapp-5ee3c.firebaseapp.com",
            projectId: "masterapp-5ee3c",
            storageBucket: "masterapp-5ee3c.firebasestorage.app",
            messagingSenderId: "917602130149",
            appId: "1:917602130149:web:9fb008b699cc3076591c0c"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const masterAppId = 'master-app-v2';

        const MASTER_PURPLE = "#BB00FF";
        const COLOR_PALETTE = [MASTER_PURPLE, "#ef4444", "#22c55e", "#f59e0b", "#a855f7", "#ec4899", "#6366f1", "#06b6d4", "#f43f5e", "#64748b"];
        const APP_ICON_SVG = `<svg viewBox="0 0 100 100" class="w-full h-full fill-none stroke-current"><path d="M20 70V30L50 55L80 30V70" stroke-width="8" stroke-linecap="round" stroke-linejoin="round"/><path d="M65 75L75 85L95 65" stroke-width="8" stroke-linecap="round" stroke-linejoin="round" class="text-emerald-500"/></svg>`;

        let currentUser = null;
        let allTasks = [];
        let categoryColors = {};
        let viewingUser = "";
        let activeTab = 'kanban';
        let editingTaskId = null;
        let selectedColor = COLOR_PALETTE[0];
        let isRegistering = false;

        // INICIAR
        async function startApp() {
            await signInAnonymously(auth);
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    const session = localStorage.getItem('master_session');
                    if (session) {
                        currentUser = JSON.parse(session);
                        viewingUser = currentUser.username;
                        renderDashboard();
                        listenToCloudData();
                    } else {
                        renderAuth();
                    }
                }
            });
        }

        // SINCRONIZAÇÃO NUVEM
        function listenToCloudData() {
            if (!auth.currentUser) return;

            // Tarefas
            const tasksRef = collection(db, 'artifacts', masterAppId, 'public', 'data', 'tasks');
            onSnapshot(tasksRef, (snapshot) => {
                allTasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderDashboard();
            }, (err) => showToast("Erro ao sincronizar tarefas: " + err.message));

            // Cores
            const colorsRef = collection(db, 'artifacts', masterAppId, 'public', 'data', 'categories');
            onSnapshot(colorsRef, (snapshot) => {
                snapshot.docs.forEach(doc => { categoryColors[doc.id] = doc.data().color; });
                renderDashboard();
            });
        }

        // TELA DE LOGIN / REGISTO
        window.renderAuth = () => {
            document.getElementById('app').innerHTML = `
                <div class="min-h-screen flex items-center justify-center p-4">
                    <div class="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-md">
                        <div class="text-center mb-8">
                            <div class="w-16 h-16 text-master mx-auto mb-4">${APP_ICON_SVG}</div>
                            <h1 class="text-3xl font-bold text-slate-800">MasterApp</h1>
                            <p class="text-slate-500 mt-2">${isRegistering ? 'Cria a tua conta de aluno' : 'Entra no teu painel'}</p>
                        </div>
                        <div class="space-y-4">
                            <input type="text" id="auth-username" class="w-full px-4 py-3 border rounded-2xl outline-none focus:ring-2 ring-master" placeholder="Nome de Utilizador">
                            <input type="password" id="auth-password" class="w-full px-4 py-3 border rounded-2xl outline-none focus:ring-2 ring-master" placeholder="Palavra-passe">
                            <button onclick="handleAuthAction()" class="w-full bg-master text-white py-3.5 rounded-2xl font-bold shadow-lg active:scale-95 transition">
                                ${isRegistering ? 'Criar Conta Master' : 'Entrar Agora'}
                            </button>
                            <div class="text-center mt-4">
                                <button onclick="toggleAuthMode()" class="text-sm text-master font-bold hover:underline">
                                    ${isRegistering ? 'Já tenho conta. Entrar' : 'Não tens conta? Regista-te'}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        };

        window.toggleAuthMode = () => { isRegistering = !isRegistering; renderAuth(); };

        window.handleAuthAction = async () => {
            const user = document.getElementById('auth-username').value.trim();
            const pass = document.getElementById('auth-password').value;

            if (!user || !pass) return showToast("Preenche todos os campos.");

            try {
                const userRef = doc(db, 'artifacts', masterAppId, 'public', 'data', 'users', user.toLowerCase());
                const userDoc = await getDoc(userRef);

                if (isRegistering) {
                    if (userDoc.exists()) return showToast("Este nome já está em uso.");
                    await setDoc(userRef, { username: user, password: pass });
                    showToast("Conta criada!");
                } else {
                    if (!userDoc.exists() || userDoc.data().password !== pass) {
                        return showToast("Utilizador ou senha incorretos.");
                    }
                }

                currentUser = { username: user };
                viewingUser = user;
                localStorage.setItem('master_session', JSON.stringify(currentUser));
                renderDashboard();
                listenToCloudData();
            } catch (err) {
                showToast("Erro: " + err.message);
            }
        };

        window.renderDashboard = () => {
            if (!currentUser) return;
            const isOwner = currentUser.username === viewingUser;
            const userList = [...new Set(allTasks.map(t => t.owner)), currentUser.username].sort();

            document.getElementById('app').innerHTML = `
                <nav class="bg-white border-b sticky top-0 z-50">
                    <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
                        <div class="flex items-center gap-3"><div class="w-8 h-8 text-master">${APP_ICON_SVG}</div><span class="font-bold text-xl hidden sm:block">MasterApp</span></div>
                        <div class="flex items-center gap-4">
                            <div class="relative group h-16 flex items-center">
                                <button class="flex items-center gap-2 bg-slate-100 px-4 py-2 rounded-full font-bold">
                                    <span class="w-6 h-6 bg-master text-white rounded-full flex items-center justify-center text-[10px]">${viewingUser.charAt(0).toUpperCase()}</span>
                                    <span>Projeto: ${viewingUser}</span>
                                    <i class="fas fa-chevron-down text-[10px]"></i>
                                </button>
                                <div class="absolute right-0 top-full w-60 bg-white rounded-2xl shadow-2xl border hidden group-hover:block overflow-hidden z-[100]">
                                    <div class="p-3 text-[10px] font-bold text-slate-400 uppercase bg-slate-50 border-b">Projetos Ativos:</div>
                                    <div class="max-h-[300px] overflow-y-auto custom-scrollbar">
                                        ${userList.map(u => `
                                            <button onclick="switchProject('${u}')" class="w-full text-left px-5 py-3.5 text-sm hover:bg-purple-50 ${viewingUser === u ? 'text-master font-bold' : ''}">
                                                ${u} ${u === currentUser.username ? '(Eu)' : ''}
                                            </button>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                            <button onclick="askLogout()" class="text-slate-400 hover:text-red-500 p-2"><i class="fas fa-sign-out-alt"></i></button>
                        </div>
                    </div>
                </nav>

                <main class="max-w-7xl mx-auto px-4 py-8">
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-6 mb-10">
                        <h2 class="text-3xl font-extrabold text-slate-800">${isOwner ? 'O Meu Quadro' : `Projeto de ${viewingUser}`}</h2>
                        <div class="flex items-center bg-slate-200 p-1 rounded-2xl shadow-inner">
                            <button onclick="switchTab('categories')" class="px-6 py-2.5 rounded-xl text-sm font-bold ${activeTab === 'categories' ? 'bg-white shadow-md text-master' : ''}">Categorias</button>
                            <button onclick="switchTab('kanban')" class="px-6 py-2.5 rounded-xl text-sm font-bold ${activeTab === 'kanban' ? 'bg-white shadow-md text-master' : ''}">Kanban</button>
                        </div>
                    </div>

                    ${isOwner ? `<button onclick="openAddTaskModal()" class="mb-8 bg-master text-white px-8 py-4 rounded-2xl font-bold shadow-xl hover-master transition">Adicionar Tarefa</button>` : ''}
                    <div id="main-content">${activeTab === 'kanban' ? renderKanban() : renderCategories()}</div>
                </main>

                <!-- Modal Task -->
                <div id="task-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-md z-[100] hidden items-center justify-center p-4">
                    <div class="bg-white rounded-3xl shadow-2xl w-full max-w-lg overflow-hidden" onclick="event.stopPropagation()">
                        <div class="p-6 border-b flex justify-between items-center"><h3 class="text-xl font-bold" id="modal-title"></h3><button onclick="closeTaskModal()" class="text-2xl text-slate-400">&times;</button></div>
                        <div class="p-8 space-y-6">
                            <input type="text" id="new-title" class="w-full px-4 py-3 border rounded-xl outline-none focus:ring-2 ring-master" placeholder="O que precisa de fazer?">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                                <div class="relative">
                                    <input type="text" id="new-category" class="w-full px-4 py-3 border rounded-xl outline-none" placeholder="Categoria">
                                    <div class="mt-4 flex flex-wrap gap-2">
                                        ${COLOR_PALETTE.map(hex => `<div onclick="pickColor('${hex}')" class="color-dot w-7 h-7" style="background-color: ${hex}" data-color="${hex}"></div>`).join('')}
                                    </div>
                                </div>
                                <input type="date" id="new-date" class="w-full px-4 py-3 border rounded-xl">
                            </div>
                            <select id="new-status" class="w-full px-4 py-3 border rounded-xl"><option value="não iniciada">Não iniciada</option><option value="em progresso">Em progresso</option><option value="completa">Completa</option></select>
                        </div>
                        <div class="p-6 bg-slate-50 flex gap-4"><button onclick="closeTaskModal()" class="flex-1 font-bold text-slate-400">Cancelar</button><button onclick="saveTask()" class="flex-1 bg-master text-white py-3.5 rounded-2xl font-bold">Guardar</button></div>
                    </div>
                </div>
            `;
            pickColor(selectedColor);
        };

        // KANBAN RENDER
        function renderKanban() {
            const userTasks = allTasks.filter(t => t.owner === viewingUser);
            const cols = [{id:'não iniciada',l:'Não Iniciada',c:'bg-red-500'},{id:'em progresso',l:'Em Progresso',c:'bg-amber-500'},{id:'completa',l:'Completa',c:'bg-emerald-500'}];
            return `<div class="kanban-container custom-scrollbar px-2">${cols.map(col => `
                <div class="kanban-column bg-slate-200/40 p-5 rounded-3xl flex flex-col gap-5 border">
                    <div class="flex items-center justify-between"><div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full ${col.c}"></div><h3 class="font-bold text-slate-500 text-[12px] uppercase">${col.l}</h3></div></div>
                    <div class="flex flex-col gap-4 overflow-y-auto">${userTasks.filter(t => t.status === col.id).map(t => renderTaskCard(t)).join('')}</div>
                </div>`).join('')}</div>`;
        }

        // CATEGORIES RENDER
        function renderCategories() {
            const userTasks = allTasks.filter(t => t.owner === viewingUser);
            const cats = [...new Set(userTasks.map(t => t.category))].sort();
            return `<div class="space-y-10">${cats.map(cat => {
                const color = categoryColors[cat] || '#94a3b8';
                return `<div class="bg-white rounded-3xl shadow-sm border overflow-hidden">
                    <div class="px-8 py-4 border-b font-bold" style="background-color:${color}08;color:${color}">${cat}</div>
                    <div class="p-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">${userTasks.filter(t => t.category === cat).map(t => renderTaskCard(t)).join('')}</div>
                </div>`;
            }).join('')}</div>`;
        }

        // TASK CARD
        function renderTaskCard(t) {
            const isOwner = currentUser.username === viewingUser;
            const config = {'não iniciada':'bg-red-50 text-red-600 border-red-100','em progresso':'bg-amber-50 text-amber-700 border-amber-100','completa':'bg-emerald-50 text-emerald-700 border-emerald-100'};
            return `<div class="task-card bg-white p-5 rounded-2xl border shadow-sm group">
                <div class="flex justify-between mb-4"><span class="text-[9px] font-bold uppercase px-3 py-1 rounded-full border ${config[t.status]}">${t.status}</span>
                ${isOwner ? `<div class="flex gap-2 opacity-0 group-hover:opacity-100 transition"><button onclick="openEditTaskModal('${t.id}')"><i class="fas fa-edit text-slate-400"></i></button><button onclick="askDeleteTask('${t.id}')"><i class="fas fa-trash text-red-400"></i></button></div>` : ''}</div>
                <h4 class="font-bold text-sm mb-4">${t.title}</h4>
                <div class="flex items-center justify-between text-[10px] border-t pt-4"><span>${t.date || 'Sem data'}</span><span class="font-bold px-2 py-0.5 rounded" style="color:${categoryColors[t.category]};background:${categoryColors[t.category]}15"># ${t.category}</span></div>
            </div>`;
        }

        // AÇÕES NUVEM
        window.saveTask = async () => {
            const title = document.getElementById('new-title').value.trim();
            const category = document.getElementById('new-category').value.trim();
            const date = document.getElementById('new-date').value;
            const status = document.getElementById('new-status').value;

            if (!title || !category) return showToast("Título e Categoria são obrigatórios.");

            try {
                await setDoc(doc(db, 'artifacts', masterAppId, 'public', 'data', 'categories', category), { color: selectedColor });
                const taskData = { owner: currentUser.username, title, category, date, status, updated: Date.now() };

                if (editingTaskId) {
                    await updateDoc(doc(db, 'artifacts', masterAppId, 'public', 'data', 'tasks', editingTaskId), taskData);
                } else {
                    await addDoc(collection(db, 'artifacts', masterAppId, 'public', 'data', 'tasks'), taskData);
                }
                closeTaskModal();
                showToast("Sincronizado!");
            } catch (err) {
                showToast("Erro ao guardar: " + err.message);
            }
        };

        window.deleteTaskCloud = async (id) => {
            try {
                await deleteDoc(doc(db, 'artifacts', masterAppId, 'public', 'data', 'tasks', id));
                closeConfirmModal();
                showToast("Removido.");
            } catch (err) { showToast("Erro ao apagar."); }
        };

        // UTILS
        window.switchProject = (u) => { viewingUser = u; renderDashboard(); };
        window.switchTab = (t) => { activeTab = t; renderDashboard(); };
        window.pickColor = (hex) => {
            selectedColor = hex;
            document.querySelectorAll('.color-dot').forEach(d => d.classList.toggle('active', d.dataset.color === hex));
        };
        window.showToast = (msg) => {
            const t = document.getElementById('toast');
            document.getElementById('toast-message').innerText = msg;
            t.classList.remove('hidden');
            setTimeout(() => t.classList.add('hidden'), 4000);
        };
        window.openAddTaskModal = () => {
            editingTaskId = null;
            document.getElementById('task-modal').classList.add('modal-active');
            document.getElementById('modal-title').innerText = "Nova Tarefa";
            document.getElementById('new-title').value = "";
            document.getElementById('new-category').value = "";
            document.getElementById('new-date').value = "";
            document.getElementById('new-status').value = "não iniciada";
        };
        window.openEditTaskModal = (id) => {
            const t = allTasks.find(x => x.id === id);
            editingTaskId = id;
            selectedColor = categoryColors[t.category] || COLOR_PALETTE[0];
            document.getElementById('task-modal').classList.add('modal-active');
            document.getElementById('modal-title').innerText = "Editar Tarefa";
            document.getElementById('new-title').value = t.title;
            document.getElementById('new-category').value = t.category;
            document.getElementById('new-date').value = t.date;
            document.getElementById('new-status').value = t.status;
        };
        window.closeTaskModal = () => document.getElementById('task-modal').classList.remove('modal-active');
        window.askDeleteTask = (id) => {
            const modal = document.getElementById('confirm-modal');
            document.getElementById('confirm-title').innerText = "Apagar Tarefa?";
            document.getElementById('confirm-text').innerText = "Remover permanentemente do MasterApp.";
            const btn = document.getElementById('confirm-action-btn');
            btn.onclick = () => deleteTaskCloud(id);
            modal.classList.add('modal-active');
        };
        window.closeConfirmModal = () => document.getElementById('confirm-modal').classList.remove('modal-active');
        window.askLogout = () => { localStorage.removeItem('master_session'); location.reload(); };

        startApp();
    </script>
</body>
</html>
