<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MasterApp - Gestor de Tarefas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        /* MasterApp Purple Theme */
        .bg-master { background-color: #BB00FF; }
        .text-master { color: #BB00FF; }
        .border-master { border-color: #BB00FF; }
        .ring-master:focus { --tw-ring-color: #BB00FF; border-color: #BB00FF; }
        .hover-master:hover { opacity: 0.9; }

        /* Estrutura Kanban com Scroll Horizontal */
        .kanban-container {
            display: flex;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            gap: 1.5rem;
            padding-bottom: 1.5rem;
            -webkit-overflow-scrolling: touch;
        }
        .kanban-column {
            flex: 0 0 300px;
            scroll-snap-align: center;
            min-height: 70vh;
        }
        @media (min-width: 768px) { .kanban-column { flex: 0 0 350px; scroll-snap-align: start; } }

        .task-card { transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .task-card:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(187, 0, 255, 0.15); }

        .custom-scrollbar::-webkit-scrollbar { height: 8px; width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        .modal-active { display: flex !important; animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .color-dot { width: 28px; height: 28px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: all 0.2s; }
        .color-dot.active { border-color: #1e293b; transform: scale(1.2); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        
        .category-dropdown { 
            max-height: 180px; 
            overflow-y: auto; 
            z-index: 150; 
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 0 0 12px 12px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 custom-scrollbar">

    <div id="app">
        <!-- Loader de Inicialização -->
        <div class="min-h-screen flex items-center justify-center bg-slate-50">
            <div class="text-center p-6">
                <div class="w-16 h-16 text-master mx-auto mb-4 animate-bounce">
                    <svg viewBox="0 0 100 100" class="fill-none stroke-current"><path d="M20 70V30L50 55L80 30V70" stroke-width="8" stroke-linecap="round" stroke-linejoin="round"/><path d="M65 75L75 85L95 65" stroke-width="8" stroke-linecap="round" stroke-linejoin="round" class="text-emerald-500"/></svg>
                </div>
                <h2 class="text-xl font-bold text-slate-800 mb-2 tracking-tight">MasterApp</h2>
                <p id="loading-status" class="text-slate-400 text-sm animate-pulse italic">A sincronizar o seu universo produtivo...</p>
                <div id="connection-error" class="hidden mt-8 p-4 bg-red-50 rounded-xl border border-red-100 max-w-xs mx-auto">
                    <p class="text-red-600 text-xs mb-3 font-medium text-center">A conexão está a demorar. Verifique se a 'Autenticação Anônima' está ativa no Firebase.</p>
                    <button onclick="location.reload()" class="bg-white text-red-600 text-[10px] px-4 py-2 rounded-lg font-bold shadow-sm border border-red-200 w-full">RECARREGAR APLICAÇÃO</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modais Genéricos -->
    <div id="confirm-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[200] hidden items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-sm p-8 text-center">
            <h3 class="text-xl font-bold mb-2 text-slate-800" id="confirm-title">Ação Requerida</h3>
            <p class="text-slate-500 mb-6 text-sm" id="confirm-text"></p>
            <div class="flex gap-3">
                <button onclick="closeConfirmModal()" class="flex-1 px-4 py-3 bg-slate-100 rounded-xl font-bold text-slate-500 hover:bg-slate-200 transition">Cancelar</button>
                <button id="confirm-action-btn" class="flex-1 px-4 py-3 bg-red-600 text-white font-bold rounded-xl shadow-lg active:scale-95 transition">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Feedback Visual (Toast) -->
    <div id="toast" class="fixed top-20 left-1/2 -translate-x-1/2 z-[300] hidden">
        <div class="bg-slate-800 text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-3 border border-slate-700">
            <i class="fas fa-check-circle text-purple-400"></i>
            <span id="toast-message" class="text-sm font-semibold"></span>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, addDoc, updateDoc, deleteDoc, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // CONFIGURAÇÃO FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyBhcrxANmCC8-3vns_db3qlKmhRZYh3yxQ",
            authDomain: "masterapp-5ee3c.firebaseapp.com",
            projectId: "masterapp-5ee3c",
            storageBucket: "masterapp-5ee3c.firebasestorage.app",
            messagingSenderId: "917602130149",
            appId: "1:917602130149:web:9fb008b699cc3076591c0c"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const masterAppId = 'master-app-final-prod-v1';

        // Estilos e Identidade
        const MASTER_PURPLE = "#BB00FF";
        const COLOR_PALETTE = [MASTER_PURPLE, "#ef4444", "#22c55e", "#f59e0b", "#a855f7", "#ec4899", "#6366f1", "#06b6d4", "#f43f5e", "#64748b"];
        const APP_ICON_SVG = `<svg viewBox="0 0 100 100" class="w-full h-full fill-none stroke-current"><path d="M20 70V30L50 55L80 30V70" stroke-width="8" stroke-linecap="round" stroke-linejoin="round"/><path d="M65 75L75 85L95 65" stroke-width="8" stroke-linecap="round" stroke-linejoin="round" class="text-emerald-500"/></svg>`;

        // Estado Global
        let currentUser = null;
        let allTasks = [];
        let categoryColors = {};
        let viewingUser = "";
        let activeTab = 'kanban';
        let editingTaskId = null;
        let selectedColor = COLOR_PALETTE[0];
        let isRegistering = false;

        // --- INICIALIZAÇÃO ---
        async function startApp() {
            const errorTimer = setTimeout(() => {
                document.getElementById('connection-error').classList.remove('hidden');
            }, 8000);

            try {
                await signInAnonymously(auth);
                onAuthStateChanged(auth, (user) => {
                    clearTimeout(errorTimer);
                    if (user) {
                        const session = localStorage.getItem('master_session');
                        if (session) {
                            currentUser = JSON.parse(session);
                            viewingUser = currentUser.username;
                            renderDashboard();
                            listenToCloudData();
                        } else {
                            renderAuth();
                        }
                    }
                });
            } catch (err) { console.error("Firebase Init Error:", err); }
        }

        // --- SINCRONIZAÇÃO NUVEM ---
        function listenToCloudData() {
            if (!auth.currentUser) return;

            // Escuta Tarefas (Públicas)
            onSnapshot(collection(db, 'artifacts', masterAppId, 'public', 'data', 'tasks'), (snapshot) => {
                allTasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderDashboard();
            });

            // Escuta Categorias (Cores)
            onSnapshot(collection(db, 'artifacts', masterAppId, 'public', 'data', 'categories'), (snapshot) => {
                snapshot.docs.forEach(doc => { categoryColors[doc.id] = doc.data().color; });
                renderDashboard();
            });
        }

        // --- INTERFACE DE LOGIN E CADASTRO ---
        window.renderAuth = () => {
            document.getElementById('app').innerHTML = `
                <div class="min-h-screen flex items-center justify-center p-4 bg-slate-50">
                    <div class="bg-white p-10 rounded-[2.5rem] shadow-2xl w-full max-w-md border border-slate-100">
                        <div class="text-center mb-10">
                            <div class="w-16 h-16 text-master mx-auto mb-4">${APP_ICON_SVG}</div>
                            <h1 class="text-3xl font-extrabold text-slate-800 tracking-tight">MasterApp</h1>
                            <p class="text-slate-400 mt-2 text-sm">${isRegistering ? 'Crie a sua nova conta Master' : 'Inicie a sua sessão produtiva'}</p>
                        </div>
                        <div class="space-y-4">
                            <div class="space-y-1">
                                <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest ml-1">Usuário</label>
                                <input type="text" id="auth-username" class="w-full px-5 py-3.5 border border-slate-200 rounded-2xl outline-none focus:ring-2 ring-master transition" placeholder="O seu nome">
                            </div>
                            <div class="space-y-1">
                                <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest ml-1">Senha</label>
                                <input type="password" id="auth-password" class="w-full px-5 py-3.5 border border-slate-200 rounded-2xl outline-none focus:ring-2 ring-master transition" placeholder="••••••••">
                            </div>
                            <button onclick="handleAuthAction()" class="w-full bg-master text-white py-4 rounded-2xl font-bold shadow-xl shadow-purple-200 active:scale-95 transition mt-6 uppercase tracking-wider">
                                ${isRegistering ? 'CADASTRAR' : 'Acessar'}
                            </button>
                            <div class="text-center mt-6">
                                <button onclick="toggleAuthMode()" class="text-sm text-master font-bold hover:underline">
                                    ${isRegistering ? 'Já é MasterMind? Entre aqui.' : 'Clique aqui para criar o cadastro'}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        };

        window.toggleAuthMode = () => { isRegistering = !isRegistering; renderAuth(); };

        window.handleAuthAction = async () => {
            const user = document.getElementById('auth-username').value.trim();
            const pass = document.getElementById('auth-password').value;
            if (!user || !pass) return showToast("Preencha todos os dados.");

            try {
                const userRef = doc(db, 'artifacts', masterAppId, 'public', 'data', 'users', user.toLowerCase());
                const userDoc = await getDoc(userRef);

                if (isRegistering) {
                    if (userDoc.exists()) return showToast("Este nome já está registrado.");
                    await setDoc(userRef, { username: user, password: pass });
                    showToast("Conta criada! Bem-vindo.");
                } else {
                    if (!userDoc.exists() || userDoc.data().password !== pass) return showToast("Dados de acesso inválidos.");
                }

                currentUser = { username: user };
                viewingUser = user;
                localStorage.setItem('master_session', JSON.stringify(currentUser));
                renderDashboard();
                listenToCloudData();
            } catch (err) { showToast("Erro: " + err.message); }
        };

        // --- DASHBOARD PRINCIPAL ---
        window.renderDashboard = () => {
            if (!currentUser) return;
            const isOwner = currentUser.username === viewingUser;
            const userList = [...new Set(allTasks.map(t => t.owner)), currentUser.username].sort();

            document.getElementById('app').innerHTML = `
                <nav class="bg-white border-b border-slate-200 sticky top-0 z-50 shadow-sm">
                    <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 text-master">${APP_ICON_SVG}</div>
                            <span class="font-bold text-xl tracking-tight hidden sm:block">MasterApp</span>
                        </div>
                        <div class="flex items-center gap-4">
                            <div class="relative group h-16 flex items-center">
                                <button class="flex items-center gap-2 bg-slate-100 px-4 py-2 rounded-full font-bold text-xs hover:bg-slate-200 transition">
                                    <span class="w-6 h-6 bg-master text-white rounded-full flex items-center justify-center text-[10px] font-bold">${viewingUser.charAt(0).toUpperCase()}</span>
                                    <span>Projeto: ${viewingUser}</span>
                                    <i class="fas fa-chevron-down opacity-30"></i>
                                </button>
                                <div class="absolute right-0 top-full w-64 bg-white rounded-3xl shadow-2xl border border-slate-100 hidden group-hover:block overflow-hidden z-[100] animate-in slide-in-from-top-2 duration-200">
                                    <div class="p-4 text-[10px] font-bold text-slate-400 uppercase tracking-widest bg-slate-50 border-b">Quadros Disponíveis:</div>
                                    <div class="max-h-[350px] overflow-y-auto custom-scrollbar">
                                        ${userList.map(u => `
                                            <button onclick="switchProject('${u}')" class="w-full text-left px-5 py-4 text-sm hover:bg-purple-50 transition ${viewingUser === u ? 'text-master font-bold bg-purple-50/30' : 'text-slate-600'}">
                                                <i class="fas ${u === currentUser.username ? 'fa-user-circle' : 'fa-folder-open'} mr-2 opacity-40"></i>
                                                ${u} ${u === currentUser.username ? '(O meu)' : ''}
                                            </button>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                            <button onclick="askLogout()" class="text-slate-400 hover:text-red-500 p-2 transition"><i class="fas fa-sign-out-alt"></i></button>
                        </div>
                    </div>
                </nav>

                <main class="max-w-7xl mx-auto px-4 py-10">
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-8 mb-12">
                        <div>
                            <h2 class="text-4xl font-extrabold text-slate-800 tracking-tight">${isOwner ? 'O Meu Quadro' : `Quadro de ${viewingUser}`}</h2>
                            <p class="text-slate-400 text-sm mt-1 font-medium">Gestão inteligente e colaborativa.</p>
                        </div>
                        <div class="flex items-center bg-slate-200 p-1 rounded-2xl shadow-inner w-fit">
                            <button onclick="switchTab('categories')" class="px-8 py-3 rounded-xl text-sm font-bold transition ${activeTab === 'categories' ? 'bg-white shadow-md text-master' : 'text-slate-500 hover:text-slate-700'}">Categorias</button>
                            <button onclick="switchTab('kanban')" class="px-8 py-3 rounded-xl text-sm font-bold transition ${activeTab === 'kanban' ? 'bg-white shadow-md text-master' : 'text-slate-500 hover:text-slate-700'}">Kanban</button>
                        </div>
                    </div>

                    ${isOwner ? `
                        <button onclick="openAddTaskModal()" class="mb-10 bg-master text-white px-10 py-5 rounded-2xl font-bold shadow-2xl shadow-purple-200 hover-master transition transform active:scale-95 flex items-center gap-3">
                            <i class="fas fa-plus-circle text-lg"></i> CRIAR NOVA TAREFA
                        </button>
                    ` : `
                        <div class="mb-10 p-6 bg-purple-50 border border-purple-100 rounded-3xl flex items-center gap-4 text-purple-700 text-sm shadow-sm">
                            <i class="fas fa-eye text-lg"></i>
                            <span>Está a explorar as tarefas de <b>${viewingUser}</b>. Edição restrita ao autor.</span>
                        </div>
                    `}

                    <div id="main-content" class="${activeTab === 'kanban' ? 'overflow-hidden' : ''}">
                        ${activeTab === 'kanban' ? renderKanban() : renderCategories()}
                    </div>
                </main>

                <!-- Modal Consolidado (Tarefas e Categorias) -->
                <div id="task-modal" class="fixed inset-0 bg-slate-900/70 backdrop-blur-md z-[100] hidden items-center justify-center p-4" onclick="handleOutsideModalClick(event)">
                    <div class="bg-white rounded-[2.5rem] shadow-2xl w-full max-w-xl overflow-hidden animate-in zoom-in-95 duration-200" onclick="event.stopPropagation()">
                        <div class="p-8 border-b flex justify-between items-center bg-slate-50/50">
                            <h3 class="text-2xl font-extrabold text-slate-800 tracking-tight" id="modal-title"></h3>
                            <button onclick="closeTaskModal()" class="w-10 h-10 flex items-center justify-center rounded-full text-slate-400 hover:bg-slate-200 transition text-2xl">&times;</button>
                        </div>
                        <div class="p-10 space-y-8">
                            <div class="space-y-2">
                                <label class="block text-[10px] font-bold text-slate-400 uppercase tracking-widest ml-1">Título da Tarefa *</label>
                                <input type="text" id="new-title" class="w-full px-5 py-4 border border-slate-200 rounded-2xl outline-none focus:ring-2 ring-master text-lg font-medium transition" placeholder="O que precisa de ser feito?">
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-10">
                                <div class="relative">
                                    <label class="block text-[10px] font-bold text-slate-400 uppercase tracking-widest ml-1 mb-2">Categoria *</label>
                                    <input type="text" id="new-category" 
                                        onfocus="showCategorySuggestions()" 
                                        oninput="filterCategorySuggestions(this.value)"
                                        autocomplete="off"
                                        class="w-full px-5 py-4 border border-slate-200 rounded-2xl outline-none focus:ring-2 ring-master font-medium transition" 
                                        placeholder="Escolha ou digite">
                                    
                                    <!-- Dropdown Dinâmico -->
                                    <div id="category-suggestions" class="hidden category-dropdown custom-scrollbar"></div>

                                    <div class="mt-6">
                                        <label class="block text-[9px] font-bold text-slate-400 uppercase tracking-widest ml-1 mb-3">Atribuir Identidade (Cor) *</label>
                                        <div class="flex flex-wrap gap-3">
                                            ${COLOR_PALETTE.map(hex => `<div onclick="pickColor('${hex}')" class="color-dot" style="background-color: ${hex}" data-color="${hex}"></div>`).join('')}
                                        </div>
                                    </div>
                                </div>
                                <div class="space-y-2">
                                    <label class="block text-[10px] font-bold text-slate-400 uppercase tracking-widest ml-1">Data Limite</label>
                                    <input type="date" id="new-date" class="w-full px-5 py-4 border border-slate-200 rounded-2xl outline-none focus:ring-2 ring-master font-medium transition">
                                </div>
                            </div>
                            <div class="space-y-2">
                                <label class="block text-[10px] font-bold text-slate-400 uppercase tracking-widest ml-1">Estado do Fluxo *</label>
                                <select id="new-status" class="w-full px-5 py-4 border border-slate-200 rounded-2xl outline-none focus:ring-2 ring-master bg-white font-medium cursor-pointer">
                                    <option value="não iniciada">Não iniciada</option>
                                    <option value="em progresso">Em progresso</option>
                                    <option value="completa">Completa</option>
                                </select>
                            </div>
                        </div>
                        <div class="p-8 bg-slate-50 flex gap-4 border-t border-slate-100">
                            <button onclick="closeTaskModal()" class="flex-1 py-4 font-bold text-slate-400 hover:text-slate-600 transition">CANCELAR</button>
                            <button onclick="saveTask()" class="flex-1 bg-master text-white py-4 rounded-2xl font-bold shadow-xl shadow-purple-100 hover-master transition transform active:scale-95">SINCRONIZAR NA NUVEM</button>
                        </div>
                    </div>
                </div>
            `;
            pickColor(selectedColor);
        };

        // --- LÓGICA DE CATEGORIAS ---
        window.showCategorySuggestions = () => {
            const container = document.getElementById('category-suggestions');
            const categories = Object.keys(categoryColors).sort();
            if (categories.length === 0) return container.classList.add('hidden');
            renderCategoryList(categories);
            container.classList.remove('hidden');
        };

        window.filterCategorySuggestions = (val) => {
            const categories = Object.keys(categoryColors).filter(cat => 
                cat.toLowerCase().includes(val.toLowerCase())
            ).sort();
            const container = document.getElementById('category-suggestions');
            if (categories.length === 0) {
                container.classList.add('hidden');
            } else {
                renderCategoryList(categories);
                container.classList.remove('hidden');
            }
            if (categoryColors[val.trim()]) pickColor(categoryColors[val.trim()]);
        };

        function renderCategoryList(list) {
            const container = document.getElementById('category-suggestions');
            container.innerHTML = list.map(cat => `
                <div onclick="selectCategory('${cat}')" class="flex items-center gap-4 p-4 hover:bg-purple-50 cursor-pointer border-b border-slate-50 last:border-0 transition group">
                    <div class="w-4 h-4 rounded-full shadow-sm" style="background-color: ${categoryColors[cat]}"></div>
                    <span class="text-sm text-slate-700 font-bold group-hover:text-master">${cat}</span>
                </div>
            `).join('');
        }

        window.selectCategory = (name) => {
            document.getElementById('new-category').value = name;
            document.getElementById('category-suggestions').classList.add('hidden');
            if (categoryColors[name]) pickColor(categoryColors[name]);
        };

        window.handleOutsideModalClick = (e) => {
            const dropdown = document.getElementById('category-suggestions');
            if (dropdown) dropdown.classList.add('hidden');
        };

        // --- RENDERS DE TELA ---

        function renderKanban() {
            const userTasks = allTasks.filter(t => t.owner === viewingUser);
            const cols = [{id:'não iniciada',l:'Não Iniciada',c:'bg-red-500'},{id:'em progresso',l:'Em Progresso',c:'bg-amber-500'},{id:'completa',l:'Completa',c:'bg-emerald-500'}];
            return `<div class="kanban-container custom-scrollbar px-2">${cols.map(col => `
                <div class="kanban-column bg-slate-200/40 p-6 rounded-[2rem] flex flex-col gap-6 border border-slate-200/50 backdrop-blur-sm">
                    <div class="flex items-center justify-between px-1">
                        <div class="flex items-center gap-3">
                            <div class="w-3 h-3 rounded-full ${col.c} shadow-sm shadow-slate-300"></div>
                            <h3 class="font-bold text-slate-500 uppercase text-[12px] tracking-widest">${col.l}</h3>
                        </div>
                        <span class="bg-white text-slate-400 text-[10px] font-bold px-3 py-1 rounded-full shadow-sm">${userTasks.filter(t => t.status === col.id).length}</span>
                    </div>
                    <div class="flex flex-col gap-4 overflow-y-auto custom-scrollbar pr-1">
                        ${userTasks.filter(t => t.status === col.id).map(t => renderTaskCard(t)).join('')}
                        ${userTasks.filter(t => t.status === col.id).length === 0 ? `<div class="py-16 text-center text-slate-300 text-[11px] italic font-medium">Aguardando tarefas...</div>` : ''}
                    </div>
                </div>`).join('')}</div>`;
        }

        function renderCategories() {
            const userTasks = allTasks.filter(t => t.owner === viewingUser);
            const cats = [...new Set(userTasks.map(t => t.category))].sort();
            return cats.length === 0 ? `<div class="text-center py-32 text-slate-300 italic font-medium">Crie categorias para organizar o seu trabalho.</div>` : `<div class="space-y-12">${cats.map(cat => {
                const color = categoryColors[cat] || '#94a3b8';
                return `<div class="bg-white rounded-[2.5rem] shadow-sm border border-slate-100 overflow-hidden">
                    <div class="px-10 py-5 border-b font-extrabold flex items-center gap-3 tracking-tight" style="background-color: ${color}08; color: ${color}; text-shadow: 0 0 1px ${color}20;">
                        <i class="fas fa-hashtag text-[10px] opacity-50"></i>${cat}
                    </div>
                    <div class="p-8 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">${userTasks.filter(t => t.category === cat).map(t => renderTaskCard(t)).join('')}</div>
                </div>`;}).join('')}</div>`;
        }

        function renderTaskCard(t) {
            const isOwner = currentUser.username === viewingUser;
            const statusColors = {'não iniciada':'bg-red-500','em progresso':'bg-amber-500','completa':'bg-emerald-500'};
            const catColor = categoryColors[t.category] || '#94a3b8';
            
            return `<div class="task-card bg-white p-6 rounded-3xl border border-slate-100 shadow-sm group">
                <div class="flex justify-between mb-5">
                    <div class="w-3 h-3 rounded-full ${statusColors[t.status]} shadow-sm shadow-slate-200" title="${t.status}"></div>
                ${isOwner ? `<div class="flex gap-1 opacity-0 group-hover:opacity-100 transition"><button onclick="openEditTaskModal('${t.id}')" class="p-2 text-slate-400 hover:text-master transition"><i class="fas fa-edit"></i></button><button onclick="askDeleteTask('${t.id}')" class="p-2 text-slate-400 hover:text-red-500 transition"><i class="fas fa-trash-alt"></i></button></div>` : ''}</div>
                <h4 class="font-bold text-slate-800 text-[15px] mb-5 leading-relaxed tracking-tight">${t.title}</h4>
                <div class="flex items-center justify-between text-[10px] border-t border-slate-50 pt-5 mt-2">
                    <span class="text-slate-400 font-bold tracking-tight"><i class="far fa-calendar-alt mr-1.5 opacity-60"></i>${t.date || 'SEM PRAZO'}</span>
                    <span class="font-bold px-3 py-1 rounded-lg shadow-sm" style="color: ${catColor}; background-color: ${catColor}12;"># ${t.category}</span>
                </div>
            </div>`;
        }

        // --- AÇÕES FIRESTORE ---

        window.saveTask = async () => {
            const title = document.getElementById('new-title').value.trim();
            const category = document.getElementById('new-category').value.trim();
            const date = document.getElementById('new-date').value;
            const status = document.getElementById('new-status').value;
            if (!title || !category) return showToast("Título e Categoria obrigatórios!");

            try {
                await setDoc(doc(db, 'artifacts', masterAppId, 'public', 'data', 'categories', category), { color: selectedColor });
                const taskData = { owner: currentUser.username, title, category, date, status, updated: Date.now() };
                if (editingTaskId) await updateDoc(doc(db, 'artifacts', masterAppId, 'public', 'data', 'tasks', editingTaskId), taskData);
                else await addDoc(collection(db, 'artifacts', masterAppId, 'public', 'data', 'tasks'), taskData);
                closeTaskModal();
                showToast("Sincronizado Master!");
            } catch (err) { showToast("Erro Nuvem: " + err.message); }
        };

        window.deleteTaskCloud = async (id) => {
            try {
                await deleteDoc(doc(db, 'artifacts', masterAppId, 'public', 'data', 'tasks', id));
                closeConfirmModal();
                showToast("Tarefa eliminada.");
            } catch (err) { showToast("Erro ao apagar."); }
        };

        // --- UTILITÁRIOS ---
        window.switchProject = (u) => { viewingUser = u; renderDashboard(); showToast(`Quadro: ${u}`); };
        window.switchTab = (t) => { activeTab = t; renderDashboard(); };
        window.pickColor = (hex) => {
            selectedColor = hex;
            document.querySelectorAll('.color-dot').forEach(d => d.classList.toggle('active', d.dataset.color === hex));
        };
        window.showToast = (msg) => {
            const t = document.getElementById('toast');
            document.getElementById('toast-message').innerText = msg;
            t.classList.remove('hidden');
            setTimeout(() => t.classList.add('hidden'), 5000);
        };
        window.openAddTaskModal = () => {
            editingTaskId = null;
            selectedColor = COLOR_PALETTE[0];
            document.getElementById('task-modal').classList.add('modal-active');
            document.getElementById('modal-title').innerText = "Nova Tarefa Master";
            document.getElementById('new-title').value = "";
            document.getElementById('new-category').value = "";
            document.getElementById('new-date').value = "";
            document.getElementById('new-status').value = "não iniciada";
        };
        window.openEditTaskModal = (id) => {
            const t = allTasks.find(x => x.id === id);
            editingTaskId = id;
            selectedColor = categoryColors[t.category] || COLOR_PALETTE[0];
            document.getElementById('task-modal').classList.add('modal-active');
            document.getElementById('modal-title').innerText = "Editar Tarefa Master";
            document.getElementById('new-title').value = t.title;
            document.getElementById('new-category').value = t.category;
            document.getElementById('new-date').value = t.date;
            document.getElementById('new-status').value = t.status;
        };
        window.closeTaskModal = () => {
            document.getElementById('task-modal').classList.remove('modal-active');
            document.getElementById('category-suggestions').classList.add('hidden');
        };
        window.askDeleteTask = (id) => {
            const modal = document.getElementById('confirm-modal');
            document.getElementById('confirm-title').innerText = "Eliminar Tarefa?";
            document.getElementById('confirm-text').innerText = "Esta ação removerá o item permanentemente para toda a comunidade.";
            const btn = document.getElementById('confirm-action-btn');
            btn.onclick = () => deleteTaskCloud(id);
            modal.classList.add('modal-active');
        };
        window.closeConfirmModal = () => document.getElementById('confirm-modal').classList.remove('modal-active');
        window.askLogout = () => { 
            localStorage.removeItem('master_session'); 
            localStorage.removeItem('master_profile');
            location.reload(); 
        };

        startApp();
    </script>
</body>
</html>
